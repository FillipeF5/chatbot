<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Admin - Gerenciador de Fluxos</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: #f4f7f6;
      color: #333;
    }

    .container {
      max-width: 1100px;
      margin: auto;
    }

    .card {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    h1,
    h2 {
      color: #2c3e50;
    }

    /* Tabela de Fluxos */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th,
    td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #34495e;
      color: white;
    }

    .btn-edit {
      color: #3498db;
      cursor: pointer;
      font-weight: bold;
      border: none;
      background: none;
    }

    .btn-delete {
      color: #e74c3c;
      cursor: pointer;
      margin-left: 10px;
      border: none;
      background: none;
    }

    /* Editor de Passo */
    .form-box {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      background: #fafafa;
      padding: 20px;
      border-radius: 8px;
      border: 1px dashed #ccc;
    }

    .full-width {
      grid-column: span 2;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-sizing: border-box;
    }

    /* √Årea de Bot√µes din√¢micos */
    .button-row {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
      align-items: center;
    }

    .btn-add-opt {
      background: #3498db;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }

    .btn-save-main {
      background: #27ae60;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
      width: 100%;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Painel de Controle ‚Äî FiliPingu üêß</h1>
    <p><a href="/">‚¨Ö Ver Site</a> | <a href="/admin">üîÑ Atualizar Painel</a></p>

    <div class="card">
      <h2>‚öôÔ∏è Configura√ß√µes Gerais</h2>
      <div class="form-box">
        <div>
          <label>Nome do Est√∫dio</label>
          <input type="text" id="cfg_name">
        </div>
        <div>
          <label>WhatsApp</label>
          <input type="text" id="cfg_whatsapp">
        </div>
      </div>
      <button class="btn-save-main" onclick="saveGeneralConfig()">Salvar Configura√ß√µes Gerais</button>
    </div>

    <div class="card">
      <h2>üå≥ Fluxo de Conversa (Perguntas e Respostas)</h2>

      <div id="editor-fluxo" class="form-box" style="margin-bottom: 30px; border: 2px solid #3498db;">
        <div class="full-width">
          <h3 id="editor-title">Criar Novo Passo</h3>
        </div>
        <div>
          <label>ID √önico (ex: info_precos)</label>
          <input type="text" id="step_id" placeholder="Sem espa√ßos">
        </div>
        <div class="full-width">
          <label>Mensagem do Bot (O que ele vai falar)</label>
          <textarea id="step_message" placeholder="Ol√°! O pre√ßo come√ßa em..."></textarea>
        </div>

        <div class="full-width">
          <label><strong>Bot√µes de Resposta do Cliente:</strong></label>
          <div id="buttons-container">
          </div>
          <button class="btn-add-opt" onclick="addButtonRow()">+ Adicionar Bot√£o</button>
        </div>

        <div class="full-width">
          <button class="btn-save-main" onclick="saveStep()" style="background: #3498db;">Salvar Passo do Fluxo</button>
          <button onclick="resetEditor()"
            style="border:none; background:none; color:gray; cursor:pointer;">Cancelar</button>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>ID do Passo</th>
            <th>Mensagem</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="steps-table-body">
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // --- L√ìGICA DO CRUD DE FLUXOS ---

    // Carregar dados iniciais
    document.addEventListener('DOMContentLoaded', () => {
      loadGeneralConfig();
      loadSteps();
    });

    function loadGeneralConfig() {
      fetch('/api/bot/config').then(r => r.json()).then(data => {
        document.getElementById('cfg_name').value = data.settings.establishment_name || "";
        document.getElementById('cfg_whatsapp').value = data.settings.whatsapp_number || "";
      });
    }

    function loadSteps() {
      fetch('/api/bot/config').then(r => r.json()).then(data => {
        const tbody = document.getElementById('steps-table-body');
        tbody.innerHTML = "";

        Object.keys(data.flows).forEach(id => {
          const flow = data.flows[id];
          tbody.innerHTML += `
            <tr>
              <td><strong>${id}</strong></td>
              <td>${flow.message.substring(0, 50)}...</td>
              <td>
                <button class="btn-edit" onclick="editStep('${id}', ${JSON.stringify(flow).replace(/"/g, '&quot;')})">Editar</button>
                <button class="btn-delete" onclick="deleteStep('${id}')">Excluir</button>
              </td>
            </tr>
          `;
        });
      });
    }

    // Gerenciamento din√¢mico de bot√µes no formul√°rio
    function addButtonRow(label = "", action = "") {
      const container = document.getElementById('buttons-container');
      const div = document.createElement('div');
      div.className = 'button-row';
      div.innerHTML = `
        <input type="text" placeholder="Texto do Bot√£o" value="${label}" class="opt-label">
        <input type="text" placeholder="ID de Destino (Action)" value="${action}" class="opt-action">
        <button onclick="this.parentElement.remove()" style="color:red; border:none; background:none; cursor:pointer;">‚úñ</button>
      `;
      container.appendChild(div);
    }

    function saveStep() {
      const id = document.getElementById('step_id').value;
      const message = document.getElementById('step_message').value;
      const labels = document.querySelectorAll('.opt-label');
      const actions = document.querySelectorAll('.opt-action');

      const options = [];
      labels.forEach((l, i) => {
        if (l.value) options.push({ label: l.value, action: actions[i].value });
      });

      const payload = { id, message, options };

      fetch('/admin/api/steps/save?auth={{ auth_token }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(() => {
        alert("Passo salvo!");
        resetEditor();
        loadSteps();
      });
    }

    function editStep(id, data) {
      document.getElementById('editor-title').innerText = "Editando Passo: " + id;
      document.getElementById('step_id').value = id;
      document.getElementById('step_id').disabled = true;
      document.getElementById('step_message').value = data.message;

      const container = document.getElementById('buttons-container');
      container.innerHTML = "";
      data.options.forEach(opt => addButtonRow(opt.label, opt.action));
      window.scrollTo(0, 500);
    }

    function resetEditor() {
      document.getElementById('editor-title').innerText = "Criar Novo Passo";
      document.getElementById('step_id').value = "";
      document.getElementById('step_id').disabled = false;
      document.getElementById('step_message').value = "";
      document.getElementById('buttons-container').innerHTML = "";
    }

    function saveGeneralConfig() {
      const payload = {
        settings: {
          establishment_name: document.getElementById('cfg_name').value,
          whatsapp_number: document.getElementById('cfg_whatsapp').value
        }
      };
      fetch('/admin/save_config?auth=admin123', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(() => alert("Configura√ß√µes gerais salvas!"));
    }

    function deleteStep(id) {
      // 1. Confirma√ß√£o de seguran√ßa
      if (!confirm(`Tem certeza que deseja excluir o passo "${id}"? Isso pode quebrar bot√µes que levam a ele.`)) {
        return;
      }

      // 2. Chamada para a API que criamos no app.py
      fetch(`/admin/api/steps/delete/${id}?auth=admin123`, {
        method: 'DELETE'
      })
        .then(res => res.json())
        .then(data => {
          if (data.status === "success") {
            alert("Passo removido com sucesso!");
            loadSteps(); // Atualiza a lista na tela automaticamente
          } else {
            alert("Erro ao excluir: " + (data.error || "Erro desconhecido"));
          }
        })
        .catch(err => {
          console.error("Erro na requisi√ß√£o:", err);
          alert("Erro de conex√£o ao tentar excluir.");
        });
    }
  
  </script>
</body>

</html>